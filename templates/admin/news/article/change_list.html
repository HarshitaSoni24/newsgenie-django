{% extends "admin/change_list.html" %}
{% load i18n admin_urls static admin_list %}

{% block content %}
<div id="content-main">
    <div class="module" id="changelist-filter">
        <h2 class="module-title">{% translate "NewsGenie Admin Dashboard" %}</h2>
        <div class="dashboard-metrics-grid">
            <div class="metric-card">
                <h3>Total Articles</h3>
                <p class="metric-value">{{ article_stats.total }}</p>
            </div>
            <div class="metric-card approved">
                <h3>Approved Articles</h3>
                <p class="metric-value">{{ article_stats.approved }}</p>
            </div>
            <div class="metric-card pending">
                <h3>Pending Articles</h3>
                <p class="metric-value">{{ article_stats.pending }}</p>
            </div>
        </div>

        <div class="dashboard-lists-row">
            <div class="dashboard-list-card">
                <h3>Top Liked Articles</h3>
                {% if top_liked_articles %}
                <ul>
                    {% for article in top_liked_articles %}
                    <li>
                        <a href="{% url 'admin:news_article_change' article.pk %}">{{ article.title|truncatechars:50 }}</a>
                        <span>({{ article.like_count }} likes)</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p>No liked articles yet.</p>
                {% endif %}
            </div>

            <div class="dashboard-list-card">
                <h3>Top Commented Articles</h3>
                {% if top_commented_articles %}
                <ul>
                    {% for article in top_commented_articles %}
                    <li>
                        <a href="{% url 'admin:news_article_change' article.pk %}">{{ article.title|truncatechars:50 }}</a>
                        <span>({{ article.comment_count }} comments)</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p>No comments yet.</p>
                {% endif %}
            </div>

            <div class="dashboard-list-card">
                <h3>Top Useful Summaries</h3>
                {% if top_useful_summaries %}
                <ul>
                    {% for article in top_useful_summaries %}
                    <li>
                        <a href="{% url 'admin:news_article_change' article.pk %}">{{ article.title|truncatechars:50 }}</a>
                        <span>({{ article.useful_count }} useful feedback)</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p>No useful feedback yet.</p>
                {% endif %}
            </div>
        </div>

        <div class="dashboard-lists-row">
            <div class="dashboard-list-card">
                <h3>Top Readers (Time)</h3>
                {% if top_readers_time %}
                <ul>
                    {# MODIFIED: Display formatted_time directly as it's pre-processed in admin.py #}
                    {% for reader in top_readers_time %}
                    <li>
                        {{ reader.username }} <span>({{ reader.formatted_time }} on page)</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p>No reading time data yet.</p>
                {% endif %}
            </div>

            <div class="dashboard-list-card">
                <h3>Top Readers (Scroll)</h3>
                {% if top_readers_scroll %}
                <ul>
                    {# MODIFIED: Display pre-calculated avg_scroll_percentage #}
                    {% for reader in top_readers_scroll %}
                    <li>
                        {{ reader.username }} <span>({{ reader.avg_scroll_percentage }} avg scroll)</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p>No scroll data yet.</p>
                {% endif %}
            </div>

            <div class="dashboard-list-card comments-moderation">
                <h3>Recent Unapproved Comments</h3>
                {% if recent_unapproved_comments %}
                <ul>
                    {% for comment in recent_unapproved_comments %}
                    <li>
                        <a href="{% url 'admin:news_comment_change' comment.pk %}">"{{ comment.content|truncatechars:50 }}"</a>
                        <p>by {{ comment.user.username }} on {{ comment.article.title|truncatechars:30 }}</p>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p>All comments approved or none submitted.</p>
                {% endif %}
            </div>
        </div>

    </div>
    {{ block.super }} {# This ensures the original changelist content (list of articles) is still rendered below the dashboard #}
</div>
{% endblock %}

{% block extrastyle %}
    {{ block.super }}
    <style>
        .dashboard-metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .metric-card {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .metric-card h3 {
            font-size: 1.1rem;
            color: #495057;
            margin-bottom: 10px;
        }
        .metric-card p.metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff; /* Primary color */
        }
        .metric-card.approved p.metric-value {
            color: #28a745; /* Success color */
        }
        .metric-card.pending p.metric-value {
            color: #ffc107; /* Warning color */
        }

        .dashboard-lists-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .dashboard-list-card {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .dashboard-list-card h3 {
            font-size: 1.2rem;
            color: #343a40;
            margin-bottom: 15px;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 10px;
        }
        .dashboard-list-card ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .dashboard-list-card ul li {
            margin-bottom: 8px;
            font-size: 0.95rem;
        }
        .dashboard-list-card ul li a {
            color: #007bff;
            text-decoration: none;
        }
        .dashboard-list-card ul li a:hover {
            text-decoration: underline;
        }
        .dashboard-list-card ul li span {
            float: right;
            color: #6c757d;
        }
        .dashboard-list-card p {
            font-size: 0.95rem;
            color: #6c757d;
        }
        .dashboard-list-card.comments-moderation ul li p {
            font-size: 0.85rem;
            color: #adb5bd;
            margin-top: 5px;
        }

        /* Dark Mode for Admin Dashboard */
        body.dark-mode .metric-card,
        body.dark-mode .dashboard-list-card {
            background-color: #2c2c4d;
            border-color: #3a3a5c;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        body.dark-mode .metric-card h3,
        body.dark-mode .dashboard-list-card h3 {
            color: #c0cff0;
            border-color: #3a3a5c;
        }
        body.dark-mode .metric-card p.metric-value {
            color: #6dd5ed;
        }
        body.dark-mode .metric-card.approved p.metric-value {
            color: #83d475;
        }
        body.dark-mode .metric-card.pending p.metric-value {
            color: #ffc107;
        }
        body.dark-mode .dashboard-list-card ul li a {
            color: #6dd5ed;
        }
        body.dark-mode .dashboard-list-card ul li span,
        body.dark-mode .dashboard-list-card p {
            color: #b0b8bf;
        }
        body.dark-mode .dashboard-list-card.comments-moderation ul li p {
            color: #aeb8c2;
        }

    </style>
{% endblock %}